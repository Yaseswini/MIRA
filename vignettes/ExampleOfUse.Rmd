---
title: "Applying MIRA to a Biological Question"
author: "John Lawson"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Applying MIRA to a Biological Question}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this vignette, we are adding annotation and using multiple samples and region sets. Only the second half of this vignette is evaluated because of the large files involved.



## Biological Question
Ewing sarcoma is a pediatric cancer defined by the fusion oncoprotein EWS-FLI1, a transcription factor. We have DNA methylation data for Ewing sarcoma samples and we want to use this data to see if Ewing samples can be distinguished from muscle-related samples. We will use MIRA to infer regulatory activity and compare MIRA scores for Ewing versus muscle samples in two region sets: First, Ewing-specific DNase hypersensitivity sites (DHSs), and second, muscle-specific DHSs.

### Input:

This vignette requires large input files, which can be dowloaded here: [MIRA_Ewing_Vignette_Files.tgz](provide_link_here). This archive contains: 
* Single-nucleotide resolution DNA methylation data (RRBS data) for 12 Ewing sarcoma samples and 12 myotube (muscle) samples recently analyzed in the paper [DNA methylation heterogeneity defines a disease spectrum in Ewing sarcoma](http://www.medical-epigenomics.org/papers/sheffield2017/).
* Two sets of regions -- one with Ewing-specific DHSs and a one with muscle-specific DHSs, obtained from the [Regulatory Elements Database](http://db.databio.org/). All data is on the hg38 reference genome.

## Package workflow
  
0. Start with appropriately formatted single-nucleotide resolution methylation data, region sets -- each with genomic regions corresponding to some biological annotation, and a sample annotation file that has sample name (sampleName column) and sample type (sampleType column).
1. Do a quick run-through of the MIRA workflow with each region set with a few samples from each condition/sample type to make sure the region sizes are reasonable (discussed later).  
    1.1. Aggregate methylation data across regions to get a MIRA signature for each region set, sample combination.  
    1.2. Calculate MIRA score for each region set, sample combination based on the shape of the MIRA signature.  
2. Based on preliminary results, pick a region size for each region set depending on what the MIRA signatures look like.  
3. Run the full MIRA analysis with chosen region sizes.  
    3.1. Aggregate methylation data across regions to get a MIRA signature for each region set, sample combination.  
    3.2. Calculate MIRA score for each region set, sample combination based on the shape of the MIRA signature.  

### Initial Run-through

First, let's load the libraries and read in the data files.

```{r, eval = TRUE, message = FALSE}
library(MIRA)
library(data.table) #fread, setkey, 
library(GenomicRanges) #GRanges, resize
data(exampleAnnoDF2)#object name: "exampleAnnoDF2", data.table
```
```{r, eval = FALSE}
# 12 Ewing samples: T1-T12
caseFiles = paste0("EWS_T", 1:12, ".bed")
# 12 muscle related samples, 3 of each type
controlFiles = c("Hsmm_", "Hsmmt_", "Hsmmfshd_","Hsmmtubefshd_")
controlFiles=paste0(controlFiles, rep(1:3, each = 4), ".bed")
RRBSFiles = c(caseFiles, controlFiles)
regionSetFiles = c("sknmc_specific.bed", "muscle_specific.bed")
BSDTList = lapply(X = RRBSFiles, FUN = BSreadBiSeq)
regionSets = lapply(X = regionSetFiles, FUN = fread)
```

Now we just need to get the data in the right format and pick initial region sizes. To get the methylation profile around our sites of interest, we are resizing the regions to 5000 bp. This is a wide initial guess compared to the average region sizes for the region sets (around 151 bp for both region sets), but we will adjust this later on.

```{r, eval = FALSE}
regionSets = lapply(X = regionSets, 
                    FUN = function(x) setNames(x, c("chr", "start", "end")))
#converting list items from data.table to GRanges objects
#strand is not relevant for our region sets
regionSets = lapply(X = regionSets, FUN = 
                        function(x) GRanges(seqnames = x$chr, 
                                              ranges = IRanges(x$start, x$end)))
regionSets[[1]] = resize(regionSets[[1]], 5000, fix = "center")
regionSets[[2]] = resize(regionSets[[2]], 5000, fix = "center")
names(regionSets) = c("Ewing_Specific", "Muscle_Specific")
```

Now we are ready to run MIRA on a subset of the samples. First, we aggregate the methylation data into bins with `returnMIRABins`. MIRA divides each region into bins and finds methylation that is contained in each bin in each region. Then matching bins are aggregated over all regions (all bin1's together, all bin2's together, etc.). An odd bin number is recommended for the sake of symmetry and MIRA scoring.

```{r, eval = FALSE}
subBSDTList=BSDTList[c(1, 5, 9, 13, 17, 21)] # three of each type
bigBin = lapply(X = subBSDTList, FUN = returnMIRABins, GRList = regionSets, 
                binNum = 21, minReads = 0, sampleNameInBSDT = TRUE)
bigBinDT1 = rbindlist(bigBin)
```

Next we add on annotation data: the experimental condition or sample type for each sample.

```{r, eval = TRUE}
# loading "bigBinDT1" object using data()
# which has binned methylation data for this step of the vignette
data(ewingMyobigBinDT1)
# data.table functions are used to add info from annotation object to bigBinDT1
setkey(exampleAnnoDF2, sampleName)
setkey(bigBinDT1, sampleName)
bigBinDT1 = merge(bigBinDT1, exampleAnnoDF2, all.x = TRUE) #adding annotation
```

Let's look at the MIRA signatures to see if we should change our region sizes.

```{r, eval = TRUE}
plotMIRARegions(binnedRegDT = bigBinDT1)
```

### Choosing Appropriate Region Sizes

While the methylation profiles look pretty good, the dips are kind of narrow for the muscle-related samples when looking at the muscle-specific region set. The scoring function in MIRA could run into problems if the dips are too narrow since it expects the dips to be at least 5 bins wide from outside edge to outside edge (that number includes the outside edges). Let's use smaller region sizes for both region sets: 4000 bp for the Ewing DHS regions and 1750 bp for the muscle DHS regions although the exact choice is somewhat arbitrary. The size of the regions should not be decreased too much however. If the regions are too small, there might be more noise since there would be less methylation data for each bin. Also, the regions must be wide enough to capture the outer edges of the dip since the outer edges are used for the MIRA score.

To implement our new region sizes:

```{r, eval = FALSE}
regionSets[[1]] = resize(regionSets[[1]], 4000, fix = "center") # Ewing
regionSets[[2]] = resize(regionSets[[2]], 1750, fix = "center") # muscle
```


### Full MIRA Analysis

Now we can run MIRA with all our samples. Let's aggregate methylation data again with `returnMIRABins`.

```{r, eval = FALSE}
bigBin = lapply(X = BSDTList, FUN = returnMIRABins, GRList = regionSets, 
                binNum = 21, minReads = 0, sampleNameInBSDT = TRUE)
bigBinDT2 = rbindlist(bigBin)
```

We add annotation data using the same process as before:

```{r, eval = TRUE}
# loading "bigBinDT2" object using data()
# which has binned methylation data for this step of the vignette
data(ewingMyobigBinDT2)
# data.table functions are used to add info from annotation object to bigBinDT2
setkey(exampleAnnoDF2, sampleName)
setkey(bigBinDT2, sampleName)
bigBinDT2 = merge(bigBinDT2, exampleAnnoDF2, all.x = TRUE) #adding annotation
```

Let's look at the MIRA signatures.

```{r, eval = TRUE}
plotMIRARegions(binnedRegDT = bigBinDT2)
```

Next we normalize the binned methylation data (the MIRA signature). Normalizing by subtracting the minimum methylation bin value from each sample/region set combination generally brings the center MIRA signatures to a similar methylation value, making the MIRA score more about the shape of the signature and less about the average methylation. We do this with `data.table` syntax. 

```{r, eval = TRUE, results = "hide"}
bigBinDT2[, methyl := methyl - min(methyl) + .05, by = .(featureID, sampleName)]
```
```{r, eval = TRUE}
plotMIRARegions(binnedRegDT = bigBinDT2)
```

Now we can calculate MIRA scores for all samples with the `scoreDip` function, again using `data.table` syntax.

```{r, eval = TRUE}
sampleScores = bigBinDT2[, .(score = scoreDip(methyl, 
                                             binCount = 21, 
                                             shoulderShift = "auto")), 
                        by = .(featureID, sampleName)]
head(sampleScores)
```

Finally, let's add the annotation data back on and take a look at the scores!

```{r, eval = TRUE}
setkey(exampleAnnoDF2, sampleName)
setkey(sampleScores, sampleName)
#adding annotation
sampleScores = merge(sampleScores, exampleAnnoDF2, all.x = TRUE)
plotMIRAScores(sampleScores)
```

## Interpreting the Results
As expected, we found that the Ewing sarcoma samples had higher MIRA scores for the Ewing-specific DHSs. The muscle-specific DHSs require more interpretation. The muscle samples on average had higher MIRA scores but there was not complete separation between the groups. This suggests that the Ewing samples still have some activity in muscle-specific regions. 

UPDATE: with the smaller regions we used. The results depended a lot on the size of the regions. With wider regions, the scores were about the same for Ewing and muscle samples (not shown in this vignette). 

## General Interpretation Tips and Caveats
In general, interpretation will depend on the samples and region sets being used. For transcription factor (TF) activity, the MIRA score does not directly tell you the absolute or even the relative activity of the TF. Since the dip in the methylation profile could be impacted by other TFs and regulatory elements as well as the TF of interest, it is possible that a sample could have a higher MIRA score for TF-binding regions than another sample yet still have less activity for that TF (but perhaps more activity for other regulatory elements that happen to also be in the same regions). In some cases, you may still be able to infer TF activity but it should just be kept in mind that other factors could affect the MIRA signatures/scores. With TF-binding region sets, it is easier to infer that the regions where the TF binds in one sample have altered activity relative to another sample, regardless of the activity of the TF itself. As a general rule, more care should be taken in interpretation when comparing very different sample types (like different tissues or cell types), than when comparing samples of the same overall type with some being experimentally perturbed (like drug-treated vs. control in the same cell type). This is because we would expect the overall epigenetic landscape to be more different between tissues/different cell types than between differently treated samples of the same type (although whether this holds will depend on the context).


## Other Tips for Using MIRA
When it comes to MIRA, lapply is your friend (although this is generally true anyway). This allows for distributed computing with mclapply if desired. 